-- Load engineered features into a materialized table for Feast
-- This table contains all 170 engineered features per SK_ID_CURR

SET search_path TO home_credit, public;

-- Drop existing table if it exists
DROP TABLE IF EXISTS features CASCADE;

-- Create features table
-- Note: Using TEXT for initial load, then we'll convert types
CREATE TABLE features (
    "SK_ID_CURR" DOUBLE PRECISION PRIMARY KEY,
    "TARGET" DOUBLE PRECISION,
    -- All 170 feature columns will be created dynamically
    -- See the COPY command below which handles column inference
    "NAME_CONTRACT_TYPE" DOUBLE PRECISION,
    "CODE_GENDER" DOUBLE PRECISION,
    "FLAG_OWN_CAR" DOUBLE PRECISION,
    "FLAG_OWN_REALTY" DOUBLE PRECISION,
    "CNT_CHILDREN" DOUBLE PRECISION,
    "AMT_INCOME_TOTAL" DOUBLE PRECISION,
    "AMT_CREDIT" DOUBLE PRECISION,
    "AMT_ANNUITY" DOUBLE PRECISION,
    "NAME_TYPE_SUITE" DOUBLE PRECISION,
    "NAME_INCOME_TYPE" DOUBLE PRECISION,
    "NAME_EDUCATION_TYPE" DOUBLE PRECISION,
    "NAME_FAMILY_STATUS" DOUBLE PRECISION,
    "NAME_HOUSING_TYPE" DOUBLE PRECISION,
    "REGION_POPULATION_RELATIVE" DOUBLE PRECISION,
    "DAYS_BIRTH" DOUBLE PRECISION,
    "DAYS_EMPLOYED" DOUBLE PRECISION,
    "DAYS_REGISTRATION" DOUBLE PRECISION,
    "DAYS_ID_PUBLISH" DOUBLE PRECISION,
    "FLAG_MOBIL" DOUBLE PRECISION,
    "FLAG_EMP_PHONE" DOUBLE PRECISION,
    "FLAG_WORK_PHONE" DOUBLE PRECISION,
    "FLAG_CONT_MOBILE" DOUBLE PRECISION,
    "FLAG_PHONE" DOUBLE PRECISION,
    "FLAG_EMAIL" DOUBLE PRECISION,
    "OCCUPATION_TYPE" DOUBLE PRECISION,
    "CNT_FAM_MEMBERS" DOUBLE PRECISION,
    "REGION_RATING_CLIENT" DOUBLE PRECISION,
    "WEEKDAY_APPR_PROCESS_START" DOUBLE PRECISION,
    "HOUR_APPR_PROCESS_START" DOUBLE PRECISION,
    "REG_REGION_NOT_LIVE_REGION" DOUBLE PRECISION,
    "REG_REGION_NOT_WORK_REGION" DOUBLE PRECISION,
    "LIVE_REGION_NOT_WORK_REGION" DOUBLE PRECISION,
    "REG_CITY_NOT_LIVE_CITY" DOUBLE PRECISION,
    "REG_CITY_NOT_WORK_CITY" DOUBLE PRECISION,
    "LIVE_CITY_NOT_WORK_CITY" DOUBLE PRECISION,
    "ORGANIZATION_TYPE" DOUBLE PRECISION,
    "EXT_SOURCE_2" DOUBLE PRECISION,
    "EXT_SOURCE_3" DOUBLE PRECISION,
    "YEARS_BEGINEXPLUATATION_AVG" DOUBLE PRECISION,
    "FLOORSMAX_AVG" DOUBLE PRECISION,
    "TOTALAREA_MODE" DOUBLE PRECISION,
    "EMERGENCYSTATE_MODE" DOUBLE PRECISION,
    "OBS_30_CNT_SOCIAL_CIRCLE" DOUBLE PRECISION,
    "DEF_30_CNT_SOCIAL_CIRCLE" DOUBLE PRECISION,
    "DEF_60_CNT_SOCIAL_CIRCLE" DOUBLE PRECISION,
    "DAYS_LAST_PHONE_CHANGE" DOUBLE PRECISION,
    "FLAG_DOCUMENT_2" DOUBLE PRECISION,
    "FLAG_DOCUMENT_3" DOUBLE PRECISION,
    "FLAG_DOCUMENT_4" DOUBLE PRECISION,
    "FLAG_DOCUMENT_5" DOUBLE PRECISION,
    "FLAG_DOCUMENT_6" DOUBLE PRECISION,
    "FLAG_DOCUMENT_7" DOUBLE PRECISION,
    "FLAG_DOCUMENT_8" DOUBLE PRECISION,
    "FLAG_DOCUMENT_9" DOUBLE PRECISION,
    "FLAG_DOCUMENT_10" DOUBLE PRECISION,
    "FLAG_DOCUMENT_11" DOUBLE PRECISION,
    "FLAG_DOCUMENT_12" DOUBLE PRECISION,
    "FLAG_DOCUMENT_13" DOUBLE PRECISION,
    "FLAG_DOCUMENT_14" DOUBLE PRECISION,
    "FLAG_DOCUMENT_15" DOUBLE PRECISION,
    "FLAG_DOCUMENT_16" DOUBLE PRECISION,
    "FLAG_DOCUMENT_17" DOUBLE PRECISION,
    "FLAG_DOCUMENT_18" DOUBLE PRECISION,
    "FLAG_DOCUMENT_19" DOUBLE PRECISION,
    "FLAG_DOCUMENT_20" DOUBLE PRECISION,
    "FLAG_DOCUMENT_21" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_HOUR" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_DAY" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_WEEK" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_MON" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_QRT" DOUBLE PRECISION,
    "AMT_REQ_CREDIT_BUREAU_YEAR" DOUBLE PRECISION,
    "outlier_label" DOUBLE PRECISION,
    "outlier_score" DOUBLE PRECISION,
    "CREDIT_INCOME_RATIO" DOUBLE PRECISION,
    "ANNUITY_INCOME_RATIO" DOUBLE PRECISION,
    "CREDIT_GOODS_RATIO" DOUBLE PRECISION,
    "ANNUITY_CREDIT_RATIO" DOUBLE PRECISION,
    "INCOME_PER_FAMILY_MEMBER" DOUBLE PRECISION,
    "CREDIT_PER_PERSON" DOUBLE PRECISION,
    "EXT_SOURCE_MEAN" DOUBLE PRECISION,
    "EXT_SOURCE_MAX" DOUBLE PRECISION,
    "EXT_SOURCE_MIN" DOUBLE PRECISION,
    "EXT_SOURCE_STD" DOUBLE PRECISION,
    "DOCUMENT_COUNT" DOUBLE PRECISION,
    "CONTACT_COUNT" DOUBLE PRECISION,
    "REGION_MISMATCH_COUNT" DOUBLE PRECISION,
    "BUREAU_DAYS_CREDIT_MEAN" DOUBLE PRECISION,
    "BUREAU_DAYS_CREDIT_MIN" DOUBLE PRECISION,
    "BUREAU_DAYS_CREDIT_MAX" DOUBLE PRECISION,
    "BUREAU_CREDIT_DAY_OVERDUE_MEAN" DOUBLE PRECISION,
    "BUREAU_CREDIT_DAY_OVERDUE_MAX" DOUBLE PRECISION,
    "BUREAU_DAYS_CREDIT_ENDDATE_MEAN" DOUBLE PRECISION,
    "BUREAU_DAYS_CREDIT_ENDDATE_MIN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_MAX_OVERDUE_MEAN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_MEAN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_SUM" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_MAX" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_DEBT_MEAN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_DEBT_SUM" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_LIMIT_MEAN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_LIMIT_SUM" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_OVERDUE_MEAN" DOUBLE PRECISION,
    "BUREAU_AMT_CREDIT_SUM_OVERDUE_SUM" DOUBLE PRECISION,
    "BUREAU_SK_ID_BUREAU_COUNT" DOUBLE PRECISION,
    "BUREAU_ACTIVE_COUNT" DOUBLE PRECISION,
    "BUREAU_CREDIT_TYPE_COUNT" DOUBLE PRECISION,
    "PREV_AMT_ANNUITY_MEAN" DOUBLE PRECISION,
    "PREV_AMT_ANNUITY_MAX" DOUBLE PRECISION,
    "PREV_AMT_ANNUITY_MIN" DOUBLE PRECISION,
    "PREV_AMT_APPLICATION_MEAN" DOUBLE PRECISION,
    "PREV_AMT_APPLICATION_MAX" DOUBLE PRECISION,
    "PREV_AMT_APPLICATION_SUM" DOUBLE PRECISION,
    "PREV_AMT_DOWN_PAYMENT_MEAN" DOUBLE PRECISION,
    "PREV_AMT_DOWN_PAYMENT_MAX" DOUBLE PRECISION,
    "PREV_AMT_GOODS_PRICE_MEAN" DOUBLE PRECISION,
    "PREV_HOUR_APPR_PROCESS_START_MEAN" DOUBLE PRECISION,
    "PREV_RATE_DOWN_PAYMENT_MEAN" DOUBLE PRECISION,
    "PREV_RATE_DOWN_PAYMENT_MAX" DOUBLE PRECISION,
    "PREV_DAYS_DECISION_MEAN" DOUBLE PRECISION,
    "PREV_DAYS_DECISION_MIN" DOUBLE PRECISION,
    "PREV_CNT_PAYMENT_MEAN" DOUBLE PRECISION,
    "PREV_CNT_PAYMENT_SUM" DOUBLE PRECISION,
    "PREV_SK_ID_PREV_COUNT" DOUBLE PRECISION,
    "PREV_APPROVED_COUNT" DOUBLE PRECISION,
    "PREV_CONTRACT_TYPE_COUNT" DOUBLE PRECISION,
    "PREV_APPROVAL_RATE" DOUBLE PRECISION,
    "POS_MONTHS_BALANCE_MEAN" DOUBLE PRECISION,
    "POS_MONTHS_BALANCE_MAX" DOUBLE PRECISION,
    "POS_CNT_INSTALMENT_MEAN" DOUBLE PRECISION,
    "POS_CNT_INSTALMENT_SUM" DOUBLE PRECISION,
    "POS_SK_DPD_MEAN" DOUBLE PRECISION,
    "POS_SK_DPD_MAX" DOUBLE PRECISION,
    "POS_SK_DPD_DEF_MEAN" DOUBLE PRECISION,
    "INST_AMT_INSTALMENT_MEAN" DOUBLE PRECISION,
    "INST_AMT_INSTALMENT_SUM" DOUBLE PRECISION,
    "INST_AMT_INSTALMENT_MAX" DOUBLE PRECISION,
    "INST_PAYMENT_DIFF_MEAN" DOUBLE PRECISION,
    "INST_PAYMENT_DIFF_SUM" DOUBLE PRECISION,
    "INST_PAYMENT_RATIO_MEAN" DOUBLE PRECISION,
    "INST_PAYMENT_RATIO_MIN" DOUBLE PRECISION,
    "INST_DAYS_DIFF_MEAN" DOUBLE PRECISION,
    "INST_DAYS_DIFF_MAX" DOUBLE PRECISION,
    "INST_LATE_PAYMENT_SUM" DOUBLE PRECISION,
    "INST_LATE_PAYMENT_MEAN" DOUBLE PRECISION,
    "KNN_TARGET_MEAN_500" DOUBLE PRECISION,
    "PREV_LAST3_AMT_CREDIT" DOUBLE PRECISION,
    "PREV_LAST3_AMT_ANNUITY" DOUBLE PRECISION,
    "PREV_LAST3_DAYS_DECISION" DOUBLE PRECISION,
    "PREV_LAST3_APPROVAL_RATE" DOUBLE PRECISION,
    "PREV_LAST5_AMT_ANNUITY" DOUBLE PRECISION,
    "PREV_FIRST2_AMT_CREDIT" DOUBLE PRECISION,
    "PREV_FIRST2_DAYS_DECISION" DOUBLE PRECISION,
    "PREV_FIRST4_AMT_CREDIT" DOUBLE PRECISION,
    "PAST_DUE_DAYS_PAST_DUE_MEAN" DOUBLE PRECISION,
    "PAST_DUE_DAYS_PAST_DUE_SUM" DOUBLE PRECISION,
    "PAST_DUE_PAYMENT_RATIO_STD" DOUBLE PRECISION,
    "PAST_DUE_SEVERITY" DOUBLE PRECISION,
    "BUREAU_DEBT_CREDIT_RATIO" DOUBLE PRECISION,
    "BUREAU_CREDIT_UTILIZATION" DOUBLE PRECISION,
    "AMT_CREDIT_div_EXT_SOURCE_3" DOUBLE PRECISION,
    "AMT_ANNUITY_div_EXT_SOURCE_3" DOUBLE PRECISION,
    "AMT_INCOME_TOTAL_div_EXT_SOURCE_3" DOUBLE PRECISION,
    "ESTIMATED_TOTAL_PAYMENT" DOUBLE PRECISION,
    "ESTIMATED_INTEREST" DOUBLE PRECISION,
    "ESTIMATED_INTEREST_RATE" DOUBLE PRECISION,
    "ESTIMATED_YEARLY_RATE" DOUBLE PRECISION,
    "DOWN_PAYMENT_AMT" DOUBLE PRECISION,
    "CREDIT_ANNUITY_YEARS" DOUBLE PRECISION,
    "INCOME_PER_YEAR_EMPLOYED" DOUBLE PRECISION
);

-- Note: The actual CSV file should be placed at: /data/processed/application_train_features.csv
-- This will be loaded when the CSV is available
-- COPY command example (to be run manually when CSV exists):
-- \COPY home_credit.features FROM '/data/processed/application_train_features.csv' WITH (FORMAT CSV, HEADER TRUE, NULL '');

-- Create index on SK_ID_CURR for fast lookups
CREATE INDEX idx_features_sk_id_curr ON features("SK_ID_CURR");

-- Add comment
COMMENT ON TABLE features IS 'Materialized features table with all 170 engineered features for model serving via Feast';
